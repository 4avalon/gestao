// backend\config\db.js

const { Client } = require('pg'); // ImportaÃ§Ã£o do PostgreSQL
const dotenv = require('dotenv');

// Carregar variÃ¡veis de ambiente
dotenv.config();

const client = new Client({
  connectionString: process.env.DATABASE_URL,
});

client.connect()
  .then(() => console.log('âœ… Conectado ao PostgreSQL com sucesso!'))
  .catch(err => console.error('âŒ Erro ao conectar ao PostgreSQL:', err));

module.exports = client;



// backend\controllers\dentistaController.js

const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const client = require("../config/db");

const SECRET_KEY = process.env.SECRET_KEY;

// ðŸ”¹ Listar todos os dentistas (Apenas ADMIN)
const listarDentistas = async (req, res) => {
    console.log('ðŸ“‹ RequisiÃ§Ã£o: Listar todos os dentistas.');
    try {
        if (!req.usuario.is_admin) {
            console.log('â›” Acesso negado. Apenas administradores podem listar dentistas.');
            return res.status(403).json({ message: 'Acesso negado. Apenas administradores podem visualizar dentistas.' });
        }
        const result = await client.query("SELECT id, nome, email, telefone, is_admin, is_verified FROM dentistas");
        res.status(200).json(result.rows);
    } catch (err) {
        console.error('âŒ Erro ao listar dentistas:', err);
        res.status(500).json({ message: 'Erro interno no servidor.' });
    }
};

// ðŸ”¹ Visualizar detalhes de um dentista
const visualizarDentista = async (req, res) => {
    const { id } = req.params;
    console.log(`ðŸ” RequisiÃ§Ã£o: Visualizar dentista ID=${id}`);
    try {
        const result = await client.query("SELECT id, nome, email, telefone, is_admin, is_verified FROM dentistas WHERE id = $1", [id]);
        if (result.rows.length === 0) {
            console.log("âŒ Dentista nÃ£o encontrado.");
            return res.status(404).json({ message: "Dentista nÃ£o encontrado." });
        }
        res.status(200).json(result.rows[0]);
    } catch (err) {
        console.error("âŒ Erro ao buscar dentista:", err);
        res.status(500).json({ message: "Erro interno no servidor." });
    }
};

// ðŸ”¹ Adicionar um novo dentista (ComeÃ§a como nÃ£o verificado)
const adicionarDentista = async (req, res) => {
    const { nome, email, telefone, senha } = req.body;
    console.log("âž• RequisiÃ§Ã£o: Adicionar dentista.", req.body);

    try {

        // const senhaHash = await bcrypt.hash(senha, 10); // ðŸ”¹ VersÃ£o com criptografia
        const senhaHash = senha; // ðŸ”¹ VersÃ£o sem criptografia (para testes rÃ¡pidos)

        const result = await client.query(
            "INSERT INTO dentistas (nome, email, telefone, senha, is_verified) VALUES ($1, $2, $3, $4, $5) RETURNING id, nome, email, telefone, is_verified",
            [nome, email, telefone, senhaHash, true] // Agora comeÃ§a como "nÃ£o verificado" tem q mudar AQUI depois
        );
        res.status(201).json({ message: "Dentista cadastrado com sucesso!", dentista: result.rows[0] });
    } catch (err) {
        console.error("âŒ Erro ao adicionar dentista:", err);
        res.status(500).json({ message: "Erro interno no servidor." });
    }
};


// ðŸ”¹ Alterar dados do dentista (Apenas o prÃ³prio dentista ou ADMIN)
const alterarDentista = async (req, res) => {
    const { id } = req.params;
    const { nome, telefone, email, senha } = req.body;
    console.log(`âœï¸ RequisiÃ§Ã£o: Alterar dentista com ID=${id}`);
    try {
        if (!req.usuario.is_admin && req.usuario.id != id) {
            return res.status(403).json({ message: "Acesso negado. VocÃª sÃ³ pode alterar seus prÃ³prios dados." });
        }
        let senhaHash = undefined;
        if (senha) {
            senhaHash = await bcrypt.hash(senha, 10);
        }
        const result = await client.query(
            "UPDATE dentistas SET nome = $1, telefone = $2, email = $3, senha = COALESCE($4, senha) WHERE id = $5 RETURNING id, nome, email, telefone, is_admin",
            [nome, telefone, email, senhaHash, id] // ðŸ”¹ Garantimos que "is_admin" nÃ£o pode ser alterado
        );
        if (result.rows.length === 0) {
            console.log("âŒ Dentista nÃ£o encontrado.");
            return res.status(404).json({ message: "Dentista nÃ£o encontrado." });
        }
        res.status(200).json({ message: "Dentista atualizado com sucesso.", dentista: result.rows[0] });
    } catch (err) {
        console.error("âŒ Erro ao alterar dentista:", err);
        res.status(500).json({ message: "Erro interno no servidor." });
    }
};

// ðŸ”¹ Remover um dentista (Apenas ADMIN)
const removerDentista = async (req, res) => {
    if (!req.usuario.is_admin) {
        return res.status(403).json({ message: "Acesso negado. Apenas administradores podem remover dentistas." });
    }
    const { id } = req.params;
    console.log(`ðŸ—‘ï¸ RequisiÃ§Ã£o: Remover dentista com ID=${id}`);
    try {
        const result = await client.query("DELETE FROM dentistas WHERE id = $1 RETURNING id, nome, email", [id]);
        if (result.rows.length === 0) {
            console.log("âŒ Dentista nÃ£o encontrado.");
            return res.status(404).json({ message: "Dentista nÃ£o encontrado." });
        }
        res.status(200).json({ message: "Dentista removido com sucesso.", dentista: result.rows[0] });
    } catch (err) {
        console.error("âŒ Erro ao remover dentista:", err);
        res.status(500).json({ message: "Erro interno no servidor." });
    }
};

// ðŸ”¹ Login do dentista com autenticaÃ§Ã£o JWT
const loginDentista = async (req, res) => {
    const { email, senha } = req.body;
    console.log(`ðŸ”‘ RequisiÃ§Ã£o: Login com email: ${email}`);

    try {
        const emailLower = email.toLowerCase(); // ðŸ”¹ Converte o email para minÃºsculas

        // Busca o dentista no banco de dados ignorando maiÃºsculas/minÃºsculas
        const result = await client.query("SELECT * FROM dentistas WHERE LOWER(email) = LOWER($1)", [emailLower]);

        if (result.rows.length === 0) {
            console.log("âŒ Dentista nÃ£o encontrado.");
            return res.status(404).json({ message: "Email ou senha incorretos." });
        }

        const dentista = result.rows[0];
/**
        // Verificando a senha com bcrypt
        const senhaValida = await bcrypt.compare(senha, dentista.senha);
        if (!senhaValida) {
            console.log("âŒ Senha incorreta.");
            return res.status(401).json({ message: "Email ou senha incorretos." });
        }
**/
                // ðŸ”¥ ComparaÃ§Ã£o direta sem bcrypt (para testes)
        if (senha !== dentista.senha) {
            console.log("âŒ Senha incorreta.");
            return res.status(401).json({ message: "Email ou senha incorretos." });
        }
        
        // Gerando token com JWT
        const token = jwt.sign(
            { id: dentista.id, email: dentista.email, is_admin: dentista.is_admin, is_verified: dentista.is_verified },
            SECRET_KEY,
            { expiresIn: "2h", algorithm: "HS256" }
        );

        console.log(`âœ… Login bem-sucedido para ${dentista.nome}`);
        console.log("ðŸ” Dados completos do dentista:", dentista);

        res.status(200).json({
            message: "Login bem-sucedido",
            token,
            dentista
        });
    } catch (err) {
        console.error("âŒ Erro ao realizar login:", err);
        res.status(500).json({ message: "Erro interno no servidor." });
    }
};


module.exports = {
    listarDentistas,
    visualizarDentista,
    adicionarDentista,
    alterarDentista,
    removerDentista,
    loginDentista,
};




// backend\controllers\pacienteController.js

const client = require('../config/db'); // ConexÃ£o com o banco de dados

// Listar todos os pacientes
const listarPacientes = async (req, res) => {
  console.log('ðŸ“‹ RequisiÃ§Ã£o: Listar todos os pacientes.');
  try {
    const result = await client.query('SELECT * FROM pacientes');
    res.status(200).json(result.rows);
  } catch (err) {
    console.error('âŒ Erro ao listar pacientes:', err);
    res.status(500).json({ message: 'Erro interno no servidor.' });
  }
};

// Adicionar um novo paciente
const adicionarPaciente = async (req, res) => {
  const { nome, email, telefone, endereco } = req.body;
  console.log('âž• RequisiÃ§Ã£o: Adicionar paciente.', req.body);

  try {
    const result = await client.query(
      'INSERT INTO pacientes (nome, email, telefone, endereco) VALUES ($1, $2, $3, $4) RETURNING *',
      [nome, email, telefone, endereco]
    );
    res.status(201).json(result.rows[0]);
  } catch (err) {
    console.error('âŒ Erro ao adicionar paciente:', err);
    res.status(500).json({ message: 'Erro interno no servidor.' });
  }
};

// Remover um paciente
const removerPaciente = async (req, res) => {
  const { id } = req.params;
  console.log(`ðŸ—‘ï¸ RequisiÃ§Ã£o: Remover paciente com ID=${id}`);

  try {
    const result = await client.query('DELETE FROM pacientes WHERE id = $1 RETURNING *', [id]);
    if (result.rows.length === 0) {
      console.log('âŒ Paciente nÃ£o encontrado.');
      return res.status(404).json({ message: 'Paciente nÃ£o encontrado.' });
    }
    res.status(200).json({ message: 'Paciente removido com sucesso.', paciente: result.rows[0] });
  } catch (err) {
    console.error('âŒ Erro ao remover paciente:', err);
    res.status(500).json({ message: 'Erro interno no servidor.' });
  }
};

module.exports = {
  listarPacientes,
  adicionarPaciente,
  removerPaciente,
};



// backend\controllers\pedidoController.js

const client = require('../config/db'); // ConexÃ£o com o banco de dados

// Listar todos os pedidos
const listarPedidos = async (req, res) => {
  console.log('ðŸ“‹ RequisiÃ§Ã£o: Listar todos os pedidos.');
  try {
    const result = await client.query('SELECT * FROM pedidos');
    res.status(200).json(result.rows);
  } catch (err) {
    console.error('âŒ Erro ao listar pedidos:', err);
    res.status(500).json({ message: 'Erro interno no servidor.' });
  }
};

const listarPedidosEmAberto = async (req, res) => {
  console.log("ðŸ“‹ RequisiÃ§Ã£o: Listar apenas pedidos em aberto.");
  try {
    const result = await client.query(
      "SELECT * FROM pedidos WHERE status NOT IN ('ConcluÃ­do', 'Cancelado') ORDER BY data_pagamento DESC"
    );
    res.status(200).json(result.rows);
  } catch (err) {
    console.error("âŒ Erro ao listar pedidos em aberto:", err);
    res.status(500).json({ message: "Erro interno no servidor." });
  }
};


// Adicionar um novo pedido
const adicionarPedido = async (req, res) => {
  const { paciente_id, descricao, status } = req.body;
  console.log('âž• RequisiÃ§Ã£o: Adicionar pedido.', req.body);

  try {
    const result = await client.query(
      'INSERT INTO pedidos (paciente_id, descricao, status) VALUES ($1, $2, $3) RETURNING *',
      [paciente_id, descricao, status]
    );
    res.status(201).json(result.rows[0]);
  } catch (err) {
    console.error('âŒ Erro ao adicionar pedido:', err);
    res.status(500).json({ message: 'Erro interno no servidor.' });
  }
};

// Remover um pedido
const removerPedido = async (req, res) => {
  const { id } = req.params;
  console.log(`ðŸ—‘ï¸ RequisiÃ§Ã£o: Remover pedido com ID=${id}`);

  try {
    const result = await client.query('DELETE FROM pedidos WHERE id = $1 RETURNING *', [id]);
    if (result.rows.length === 0) {
      console.log('âŒ Pedido nÃ£o encontrado.');
      return res.status(404).json({ message: 'Pedido nÃ£o encontrado.' });
    }
    res.status(200).json({ message: 'Pedido removido com sucesso.', pedido: result.rows[0] });
  } catch (err) {
    console.error('âŒ Erro ao remover pedido:', err);
    res.status(500).json({ message: 'Erro interno no servidor.' });
  }
};

module.exports = {
  listarPedidos,
  listarPedidosEmAberto,  
  adicionarPedido,
  removerPedido,
};




// backend\middlewares\auth.js

const jwt = require("jsonwebtoken");
const SECRET_KEY = process.env.SECRET_KEY;

// ðŸ”¹ Middleware para autenticar qualquer usuÃ¡rio logado
const autenticarToken = (req, res, next) => {
    const token = req.headers["authorization"];
    if (!token) {
        return res.status(403).json({ message: "Acesso negado. Token ausente." });
    }

    try {
        const decoded = jwt.verify(token.replace("Bearer ", ""), SECRET_KEY);
        req.usuario = decoded;
        next();
    } catch (err) {
        return res.status(401).json({ message: "Token invÃ¡lido." });
    }
};

// ðŸ”¹ Middleware para verificar se o usuÃ¡rio Ã© ADMIN
const autenticarAdmin = (req, res, next) => {
    if (!req.usuario || !req.usuario.is_admin) {
        return res.status(403).json({ message: "Acesso negado. Apenas administradores podem realizar esta aÃ§Ã£o." });
    }
    next();
};

// ðŸ”¹ Middleware para verificar se o usuÃ¡rio Ã© um dentista autenticado
const autenticarDentista = (req, res, next) => {
    if (!req.usuario) {
        return res.status(403).json({ message: "Acesso negado. Apenas dentistas autenticados podem realizar esta aÃ§Ã£o." });
    }
    next();
};

module.exports = { autenticarToken, autenticarAdmin, autenticarDentista };



// backend\middlewares\errorHandler.js

// src/middlewares/errorHandler.js
export const errorHandler = (err, req, res, next) => {
  console.error(`âŒ Erro no servidor: ${err.message}`);
  res.status(err.status || 500).json({
    message: err.message || 'Erro interno no servidor.',
    stack: process.env.NODE_ENV === 'production' ? null : err.stack, // Esconde stack em produÃ§Ã£o
  });
};



// backend\middlewares\validate.js

// src/middlewares/validate.js
import { check, validationResult } from 'express-validator';

// ValidaÃ§Ã£o para adicionar ou atualizar dentistas
export const validateDentista = [
  check('nome').notEmpty().withMessage('O nome Ã© obrigatÃ³rio'),
  check('email').isEmail().withMessage('O email precisa ser vÃ¡lido'),
  check('telefone').notEmpty().withMessage('O telefone Ã© obrigatÃ³rio'),
  check('senha').notEmpty().withMessage('A senha Ã© obrigatÃ³ria'),
];

// ValidaÃ§Ã£o para adicionar ou atualizar pacientes
export const validatePaciente = [
  check('nome').notEmpty().withMessage('O nome Ã© obrigatÃ³rio'),
  check('email').isEmail().withMessage('O email precisa ser vÃ¡lido'),
  check('telefone').notEmpty().withMessage('O telefone Ã© obrigatÃ³rio'),
  check('dentista_id').isInt().withMessage('O ID do dentista deve ser um nÃºmero vÃ¡lido'),
];

// ValidaÃ§Ã£o para adicionar ou atualizar pedidos
export const validatePedido = [
  check('paciente_id').isInt().withMessage('O ID do paciente deve ser um nÃºmero vÃ¡lido'),
  check('pedido_details').notEmpty().withMessage('Os detalhes do pedido sÃ£o obrigatÃ³rios'),
];

// Middleware para verificar erros de validaÃ§Ã£o
export const handleValidationErrors = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({ errors: errors.array() });
  }
  next();
};



// backend\routes\dentistas.js

const express = require("express");
const {
    listarDentistas,
    visualizarDentista,  // ðŸ”¹ Nova funÃ§Ã£o para buscar um dentista especÃ­fico
    adicionarDentista,
    alterarDentista,
    loginDentista,
    removerDentista
} = require("../controllers/dentistaController");

const { autenticarToken, autenticarAdmin, autenticarDentista } = require("../middlewares/auth");

const router = express.Router();

// ðŸ”’ Rotas protegidas e organizadas
router.get("/", autenticarToken, autenticarAdmin, listarDentistas);  // Apenas admins podem listar todos os dentistas
router.get("/:id", autenticarToken, visualizarDentista);  // Qualquer dentista/admin autenticado pode ver um perfil especÃ­fico
router.post("/", adicionarDentista);  
router.put("/:id", autenticarToken, autenticarDentista, alterarDentista);  // Dentista sÃ³ altera seus prÃ³prios dados
router.post("/login", loginDentista);  // Retorna tambÃ©m o tipo de usuÃ¡rio (admin/dentista)
router.delete("/:id", autenticarToken, autenticarAdmin, removerDentista);  // Apenas admins podem remover dentistas

module.exports = router;



// backend\routes\pacientes.js

const express = require('express');
const {
  listarPacientes,
  adicionarPaciente,
  removerPaciente,
} = require('../controllers/pacienteController');

const router = express.Router();

// Rotas de pacientes
router.get('/', listarPacientes);
router.post('/', adicionarPaciente);
router.delete('/:id', removerPaciente);

module.exports = router;



// backend\routes\pedidos.js

const express = require('express');
const {
  listarPedidos,
  listarPedidosEmAberto,
  adicionarPedido,
  removerPedido,
} = require('../controllers/pedidoController');

const router = express.Router();

// Rotas de pedidos
router.get('/', listarPedidos);
router.get('/abertos', listarPedidosEmAberto);
router.post('/', adicionarPedido);
router.delete('/:id', removerPedido);

module.exports = router;



// backend\server.js

const express = require('express');
const cors = require('cors');
const dotenv = require('dotenv');

// Carregar variÃ¡veis de ambiente
dotenv.config();

const dentistasRoutes = require('./routes/dentistas');
const pacientesRoutes = require('./routes/pacientes');
const pedidosRoutes = require('./routes/pedidos');

const app = express();

// ConfiguraÃ§Ãµes bÃ¡sicas
app.use(cors({ origin: '*' }));
app.use(express.json());

// Rotas
app.use('/dentistas', dentistasRoutes);
app.use('/pacientes', pacientesRoutes);
app.use('/pedidos', pedidosRoutes);

// InicializaÃ§Ã£o do servidor
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
  console.log(`âœ… 7 Servidor rodando na porta ${PORT}`);
});

